#1 Raw FASTQ
   QC / Trimming
##2 Clean Reads
    Host Contaminant Removal

Filtered Reads
###3 Taxonomic Profiling (Kraken2/MetaPhlAn3)
#### 4, 5 Optional Assembly → Binning → MAGs
######6   Gene Prediction & Functional Annotation (Prokka, HUMAnN3)
#######7  Abundance / Diversity Analysis
########8 Statistical Analysis / Visualization

##########
#1 Raw Data (FASTQ) Quality Control

Goal: Remove low-quality reads, adapters, contaminants.

Tools: FastQC, MultiQC, Trimmomatic/fastp

Example:

# Quality check
fastqc sample_R1.fastq.gz sample_R2.fastq.gz -o qc_reports/

# Adapter trimming + quality filtering
trimmomatic PE -threads 8 \
    sample_R1.fastq.gz sample_R2.fastq.gz \
    sample_R1.trimmed.fastq.gz sample_R1.unpaired.fastq.gz \
    sample_R2.trimmed.fastq.gz sample_R2.unpaired.fastq.gz \
    ILLUMINACLIP:adapters.fa:2:30:10 LEADING:3 TRAILING:3 SLIDINGWINDOW:4:20 MINLEN:50

# Summarize QC
multiqc qc_reports/

#####
##2 Host or Contaminant Filtering

Goal: Remove reads from the host (human, mouse, plant, etc.)

Tools: Bowtie2, BBMap

# Build host genome index (if not exist)
bowtie2-build host_genome.fa host_index

# Filter host reads
bowtie2 -x host_index -1 sample_R1.trimmed.fastq.gz -2 sample_R2.trimmed.fastq.gz \
    --very-sensitive -p 8 --un-conc-gz sample_clean.fastq.gz -S /dev/null


sample_clean.1.fastq.gz & sample_clean.2.fastq.gz are non-host reads.

#####
###3 Taxonomic Profiling

Goal: Identify which microbes are present and their relative abundance.

Tools: Kraken2, Bracken, MetaPhlAn3

# Kraken2 classification
kraken2 --db kraken2_db --threads 8 \
    --paired sample_clean.1.fastq.gz sample_clean.2.fastq.gz \
    --report sample.kraken.report --output sample.kraken.out

# Abundance estimation with Bracken
bracken -d kraken2_db -i sample.kraken.report -o sample.bracken.txt -r 150


Output: Taxonomic abundance at species, genus, phylum levels.

#####
####4 Assembly (Optional, for MAGs)

Goal: Assemble reads into contigs to reconstruct genomes or gene catalogs.

Tools: MEGAHIT, SPAdes, metaSPAdes

# Assemble contigs
megahit -1 sample_clean.1.fastq.gz -2 sample_clean.2.fastq.gz -o megahit_output

# Output: megahit_output/final.contigs.fa

#####
#####5 Binning (Optional, for Metagenome-Assembled Genomes, MAGs)

Goal: Group contigs into genome bins.

Tools: MetaBAT2, MaxBin2, CONCOCT

# MetaBAT2 binning
metabat2 -i megahit_output/final.contigs.fa -o bins_dir/bin


Output: bins_dir/bin.*.fa → reconstructed genomes

#####
######6 Gene Prediction / Functional Annotation

Goal: Identify genes and assign functions/pathways.

Tools: Prokka, EggNOG-mapper, KEGG, InterProScan

# Gene prediction
prokka --outdir prokka_out --prefix sample bin1.fa

# Functional annotation with EggNOG
emapper.py -i prokka_out/sample.faa -o sample.eggnog --cpu 8


Can also use HUMAnN3 for pathway-level abundance without assembly.

#####
#######7 Abundance Profiling (Genes / Pathways)

Tools: HUMAnN3 (for pathway abundance), featureCounts, Salmon (for gene abundance)

# HUMAnN3 example
humann --input sample_clean.fastq.gz --output humann_output/


Output: Gene family abundance, pathway coverage, and pathway abundance.

#####
########8 Diversity Analysis / Downstream Statistics

Goal: Alpha/beta diversity, differential abundance, functional enrichment.

Tools (R/Python): phyloseq, vegan, MicrobiomeAnalyst, Scikit-bio

library(phyloseq)
ps <- import_biom("feature-table.biom")
plot_richness(ps, measures=c("Shannon", "Simpson"))
